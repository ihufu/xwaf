# WAF 统一错误处理规范

## 1. 错误结构
所有模块统一使用以下JSON格式返回错误：
```json
{
    "code": 1001,           // 错误码
    "message": "配置错误",   // 错误描述
    "details": {},          // 详细信息
    "request_id": "",       // 请求ID
    "timestamp": 1234567890 // 时间戳
}
```

## 2. 错误码定义

### 2.1 错误码范围
- 0: 成功
- 1000-1999: 系统错误
  - 初始化错误
  - 配置错误
  - 运行时错误
  - 系统错误
  - 模板错误
  
- 2000-2999: 请求错误
  - 无效请求
  - 方法不允许
  - 请求过大
  - 无效参数
  - 请求频率限制
  
- 3000-3999: 规则错误
  - 规则引擎错误
  - 规则同步错误
  - 规则检查错误
  - 规则匹配错误
  - 规则验证错误
  
- 4000-4999: 缓存错误
  - 缓存错误
  - 缓存未命中
  - 缓存过期
  - 缓存无效
  
- 5000-5999: 安全错误
  - 安全错误
  - IP封禁
  - CC攻击
  - XSS攻击
  - SQL注入
  - 认证失败
  - 权限不足

### 2.2 错误码命名规范
- Go代码（规则引擎）使用驼峰命名，如：`ErrInit`
- Lua代码（WAF核心）使用WAF_前缀和下划线命名，如：`WAF_INIT_ERROR`
- 错误码值在两个模块中保持一致，如：
  ```
  Go: ErrInit (1000) <-> Lua: WAF_INIT_ERROR (1000)
  ```

## 3. 错误处理原则
1. 所有模块必须使用统一的错误结构
2. 错误信息必须包含足够的上下文信息
3. 错误必须可以跨模块传递和转换
4. 错误日志必须包含请求ID用于追踪
5. 错误消息必须清晰易懂，便于定位问题

## 4. 错误处理流程
1. 产生错误时，创建标准错误结构
2. 记录错误日志，包含以下信息：
   - 错误码和消息
   - 请求ID
   - 时间戳
   - 错误上下文
   - 调用栈（如果可用）
3. 通过API返回错误，注意：
   - 不要泄露敏感信息
   - 提供有意义的错误消息
   - 保持错误格式一致
4. 监控系统采集错误指标：
   - 错误频率
   - 错误类型分布
   - 错误响应时间
   - 错误影响范围

## 5. 错误码查找
错误码定义可以在以下文件中找到：
- WAF核心：`core/lua/error_codes.lua`
- 规则引擎：`rule_engine/internal/errors/codes.go`
- 配置文件：`core/lua/config.json`

## 6. 最佳实践
1. 使用统一的错误创建函数
2. 保持错误消息简洁明了
3. 在日志中提供详细上下文
4. 定期审查错误码使用情况
5. 及时更新错误处理文档